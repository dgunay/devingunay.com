<?php

/**
 * Repopulates the database with champions for later querying.
 * 
 * @author Devin Gunay <devingunay@gmail.com>
 */

require __DIR__ . '/vendor/autoload.php';
require __DIR__ . '/../config.php';

use BestBans\BanRanker;
use BestBans\ChampionGG;
use BestBans\ChampionsDatabaseRefresher;

$champion_gg = new ChampionGG($GLOBALS['champion.gg_key']);
$db = new ChampionsDatabaseRefresher(new \PDO('sqlite:' . __DIR__ . '/champions.db'));
$bb = new BanRanker($GLOBALS['champion.gg_key'], $pdo);

// get champs for all elos
$elos = [
	'bronze'     => [],
	'silver'     => [],
	'gold'       => [],
	'platinum'   => [],
	'diamond'    => [],
	'master'     => [],
	'challenger' => [],
];

foreach (array_keys($elos) as $elo) {
	echo "getting $elo..." . PHP_EOL;
	$champions = $champion_gg->get_champions($elo);
	$elos[$elo] = $champions;
}

$patch = $champion_gg->get_patch();

// TODO: grab champions dynamically from the static data site
// Map champion ID to name
if (file_exists(__DIR__ . '/riot.json')) {
	$static_champions = json_decode(file_get_contents(__DIR__ . '/riot.json'), true);
	$champ_names = [];
	foreach ($static_champions['data'] as $champ) {
		$champ_names[$champ['id']] = $champ['name'];
	}
}
else {
	echo 'Dynamic champion name querying pending Riot API access.';
	exit(1);
}


// flush champs in the database
echo 'Clearing database...' . PHP_EOL;
$pdo->query("DELETE FROM champions");

// spin up our DB and insert our champions, one row per elo
echo 'Populating database...' . PHP_EOL;
foreach ($elos as $elo => $champions) {
	foreach ($champions as $champion) {
		$statement = $pdo->prepare("INSERT INTO champions (
			id, winRate, playRate, name, elo, banValue, adjustedPickRate
		)
		VALUES (
			:id, :winRate, :playRate, :name, :elo, :banValue, :adjustedPickRate
		)");

		$adjusted_pick_rate = (100 * $champion['playRate']) / (100 - $champion['banRate']);
		$statement->execute([
			':id'               => $champion['championId'],
			':winRate'          => $champion['winRate'],
			':playRate'         => $champion['playRate'],
			':name'             => $champ_names[$champion['championId']],
			':elo'              => $champion['elo'],
			':adjustedPickRate' => $adjusted_pick_rate,
			':banValue'         => ($champion['winRate'] - 0.5) * $adjusted_pick_rate
		]);
	}
}

file_put_contents(__DIR__ . '/current_patch.txt', $patch);